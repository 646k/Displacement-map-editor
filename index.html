<html>

<head>
	<title>Displacement map editor</title>
    <style type="text/css">
        html, body {
        margin-left: 0px;
        margin-top: 0px;
        margin-right: 0px;
        margin-bottom: 0px;
        background-color: FFFFFF;
        }
	</style>

<!-- js script for Native Client -->
<script type="text/javascript">

NativeClientModule = null;  // Global application object.
statusText = 'NO-STATUS';

// Handle a message coming from the NaCl module.
function handleMessage(message_event)
{
	if(typeof message_event.data == "string")
	{
		console.log(message_event.data);
	}
	else
	{
	}
}

// Indicate success when the NaCl module has loaded.
function moduleDidLoad()
{
	NativeClientModule = document.getElementById('nacl');
	updateStatus('SUCCESS');
}

// If the page loads before the Native Client module loads, then set the
// status message indicating that the module is still loading.  Otherwise,
// do not change the status message.
function pageDidLoad()
{
	if (NativeClientModule == null)
	{
		updateStatus('LOADING...');
	}
	else
	{
		// It's possible that the Native Client module onload event fired
		// before the page's onload event.  In this case, the status message
		// will reflect 'SUCCESS', but won't be displayed.  This call will
		// display the current message.
		updateStatus();
	}
}

// Set the global status message.  If the element with id 'statusField'
// exists, then set its HTML to the status message as well.
// opt_message The message test.  If this is null or undefined, then
//     attempt to set the element with id 'statusField' to the value of
//     |statusText|.
function updateStatus(opt_message)
{
	if (opt_message)
	{
		statusText = opt_message;
	}
	var statusField = document.getElementById('statusField');
	if (statusField)
	{
		statusField.innerHTML = statusText;

		if(statusText == 'SUCCESS')
		{
			statusField.style.visibility="hidden";
			statusField.style.display="none";
		}
	}
}
</script>
</head>

<body onload="init()">

<table border="0">
	<tr>
		<td id="listener" style="width:55pc;height:43pc">
			<script type="text/javascript">
				var listener = document.getElementById('listener')
				listener.addEventListener('load', moduleDidLoad, true);
				listener.addEventListener('message', handleMessage, true);
			</script>
			
			<h2><code id="statusField">NO-STATUS</code></h2>
			
			<embed name="nacl_module"
				   id="nacl"
				   width="100%" height="100%"
				   src="nacl.nmf"
				   type="application/x-nacl" />
		</td>
		<td style="width:55pc;height:43pc" align="center">
			<br/>
			<br/>

			<canvas id="myCanvas" width="256" height="256" style="border:0px solid #c3c3c3;" onmousedown="canvasMouseDown()" onmouseup="canvasMouseUp()" onmousemove="canvasMouseMove()">
			Your browser does not support the canvas element.
			</canvas>

			<br>
			<br>

			<input type="range" id="baseHeightSlider" min="0" max="255" value="0" step="5" onchange="baseHeightChanged(this.value)" />
			<span id="range">0</span>

			<br>
			<br>

			<input type="range" id="brushHeightSlider" min="0" max="255" value="0" step="5" onchange="brushHeightChanged(this.value)" />
			<span id="brushRange">0</span>

			<br>
			<br>

			<form>
				<input type="radio" name="brushType" value="Point brush" checked="checked" onchange="brushTypeChanged(this.value)"/>Point brush<br />
				<input type="radio" name="brushType" value="Rect brush" onchange="brushTypeChanged(this.value)"/>Rect brush<br />
				<input type="radio" name="brushType" value="Bezier brush" onchange="brushTypeChanged(this.value)"/>Beizer brush
			</form>

			<br>
			<br>

			<button type="button" id="undoBtn" onclick="undo()">Undo</button>
		</td>
	</tr>
</table>

<!-- js script for the html5 canvas drawing -->
<script type="text/javascript">
var BaseHeight = 0;
var BrushHeight = 0xA0;

var gCanvas=document.getElementById("myCanvas");
var ctx=gCanvas.getContext("2d");

var currentBrushType = "Point brush";
var previousBrushType = "Point brush";

var imgData;

var ctrlKeyDown = false;
var mouseDown = false;

function init()
{
	pageDidLoad();
    document.getElementById("baseHeightSlider").value = BaseHeight;
    document.getElementById("brushHeightSlider").value = BrushHeight;
    baseHeightChanged(BaseHeight);
    brushHeightChanged(BrushHeight);
}

function baseHeightChanged(newValue)
{
	document.getElementById("range").innerHTML=newValue;
	BaseHeight = newValue;
    ctx.fillStyle= "rgb(" + BaseHeight + ", " + BaseHeight + ", " + BaseHeight + ");";
    ctx.fillRect(0,0,256,256);
}

function brushHeightChanged(newValue)
{
	document.getElementById("brushRange").innerHTML=newValue;
	BrushHeight = newValue;
}

function canvasApplyBrush(event)
{
    event = event || window.event;
    
    gCanvas=document.getElementById("myCanvas");
    
    x = event.offsetX;
    y = event.offsetY;
    
    TotalHeight = BrushHeight;
	
	storeImage();
    
    if(currentBrushType == "Point brush")
    {
        ctx.fillStyle="rgb(" + TotalHeight + ", " + TotalHeight + ", " + TotalHeight + ");";
        ctx.fillRect(x-2,y-2,4,4);
    }
    else
    if(currentBrushType == "Rect brush")
    {
		ctx.fillStyle="rgb(" + TotalHeight + ", " + TotalHeight + ", " + TotalHeight + ");";
        ctx.fillRect(x-2,y-2,4,4);
        ctx.lineTo(x, y);
    }
}

function canvasMouseMove(event)
{
	if(mouseDown)
	{
		canvasApplyBrush(event);
	}
}

function canvasMouseDown(event)
{
	mouseDown = true;
	canvasApplyBrush(event);
}

function canvasMouseUp(event)
{
	mouseDown = false;
	canvasApplyBrush(event);
}

function brushTypeChanged(newType)
{
	storeImage();
	
	previousBrushType = currentBrushType;
    currentBrushType = newType;
    
    if(previousBrushType == "Rect brush")
    {
        ctx.fill();
    }
    
    if(newType == "Rect brush")
    {
        ctx.strokeStyle="orange";
        ctx.beginPath();
    }
}

function storeImage()
{
	imgData=ctx.getImageData(0,0,256,256);
	//A new action can be undone.
	document.getElementById("undoBtn").disabled="";
}

function undo()
{
	ctx.putImageData(imgData,0,0);
	//Only 1 action can be undone at the moment.
	document.getElementById("undoBtn").disabled="disabled";
}

</script>

</body>

</html>

